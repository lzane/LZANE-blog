---
title: "Little Things Matter - è®°ä¸€ä¸ªæœ‰è¶£çš„æ€§èƒ½é—®é¢˜"
date: 2023-03-19T19:00:00+08:00
draft: false
tags:
- Tech
slug: little-things-matter
---

## TL;DR
ç¼–è¯‘å™¨ä¼˜åŒ–ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæœ‰äº›å¯¹ç¨‹åºå‘˜éå¸¸ç®€å•çš„ç‚¹ï¼Œå¯¹ç¼–è¯‘å™¨æ¥è¯´å´å¾ˆéš¾ã€‚å¾€å¾€è¿™äº›ç»†èŠ‚ç‚¹åœ¨å¹³æ—¶å¾ˆå®¹æ˜“è¢«å¿½è§†ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå¾€å¾€åœ¨å°æ•°æ®é‡çš„æ—¶å€™ä¸ä¼šè¢«å‘ç°ï¼Œè€Œå½“å¤æ‚åº¦æ˜¯æŒ‡æ•°å¢é•¿æ—¶ï¼Œåœ¨ç¨å¾®å¤§ä¸€äº›çš„æ•°æ®é‡å°±ä¼šé€ æˆæ€§èƒ½é—®é¢˜ã€‚æ‰€ä»¥æˆ‘ä»¬ç¨‹åºå‘˜éœ€è¦é‡è§†è¿™äº›ç»†èŠ‚ç‚¹ï¼Œä¸ç¼–è¯‘å™¨äº’ç›¸åˆä½œï¼Œæ‰èƒ½ç¼–å†™å‡ºé«˜æ€§èƒ½çš„ä»£ç ã€‚

## èƒŒæ™¯
å‘¨æœ«æ— æ„é—´å‘ç°ä¸€ä¸ªæ€§èƒ½é—®é¢˜ï¼Œç®€åŒ–ä¹‹åçš„ç‰ˆæœ¬å¤§æ¦‚å¦‚ä¸‹
```js
var a = 0;
for (var i = 0; i < foo(); i++) {
  a++;
}
```

å½“å›è¿‡å¤´æ¥ç»†çœ‹è¿™ä¸ªé—®é¢˜ä¹Ÿä¸éš¾å‘ç°ï¼Œé—®é¢˜çš„åŸå› æ˜¯å› ä¸ºæŠŠ`foo`æ”¾åœ¨forå¾ªç¯çš„åˆ¤æ–­æ¡ä»¶é‡Œé¢ï¼Œå®ƒä¼šåœ¨æ¯ä¸€è½®å¾ªç¯ä¸­éƒ½æ‰§è¡Œã€‚

å› ä¸º**æ­¤å¤„æ¯æ¬¡æ‰§è¡Œfooçš„è¿”å›å€¼æ˜¯ä¸å˜çš„ï¼Œä½œä¸ºäººç±»å¾ˆå®¹æ˜“å°±å¯ä»¥åˆ¤æ–­å‡ºæ¥**ï¼Œæ‰€ä»¥è„‘é‡Œé¢å†’å‡ºä¸€äº›é—®é¢˜ï¼š
1. jsè§£é‡Šè¿è¡Œæ—¶æ˜¯ä¸æ˜¯æ¯ä¸ªå¾ªç¯éƒ½ä¼šæ‰§è¡Œfooï¼Ÿ
2. è¿è¡Œå¤šæ¬¡åJITè·å–runtimeä¿¡æ¯åä¼šä¸ä¼šåšä¼˜åŒ–ï¼Ÿ
3. ç¼–è¯‘å‹è¯­è¨€åƒcå’Œgolangæ˜¯å¦ä¼šåšä¼˜åŒ–ï¼Ÿ

## æ¢ç´¢
### v8 å­—èŠ‚ç ï¼ˆbytecodeï¼‰

```js
function foo(){
  return 0x123456
}

var a = 0
for(var i=0; i<foo(); i++){
  a++
}
```

ä½¿ç”¨v8ç¼–è¯‘ä»£ç 
```
node --print-bytecode a.js
```

![](./1.png)

![](./2.png)

å¯ä»¥çœ‹åˆ°v8å­—èŠ‚ç é‡Œfooå‡½æ•°åœ¨æ¯ä¸ªå¾ªç¯ä¸­éƒ½ä¼šè¢«è°ƒç”¨ã€‚

### v8 æœºå™¨ç ï¼ˆoptimized code / X86 machine codeï¼‰

æˆ‘ä»¬çŸ¥é“v8é‡‡ç”¨äº†JITï¼Œä¼šåœ¨Ignitionå¤šæ¬¡è§£æè¿è¡Œå­—èŠ‚ç åï¼Œæ”¶é›†runtimeçš„ä¿¡æ¯ï¼Œå¦‚æœå¯ä»¥åšä¼˜åŒ–ï¼Œä¼šå°†ä¿¡æ¯ä¼ é€’ç»™TurboFanï¼Œå°†å­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç æ¥è¿è¡Œï¼Œæé«˜æ€§èƒ½ã€‚

é‚£åœ¨è½¬æ¢æˆæœºå™¨ç ä¹‹åæ˜¯å¦ä¼šå¯¹è¿™ä¸ªé—®é¢˜åšä¼˜åŒ–å‘¢ï¼Ÿ

è¿è¡Œ
```
node --print-opt-code a.js
```

å‘ç°å…¶ä¹Ÿåªæ˜¯åšäº†inlineï¼Œfooä»ç„¶åœ¨æ¯ä¸ªå¾ªç¯ä¸­éƒ½æ‰§è¡Œã€‚

![](./3.png)

### Golang æ±‡ç¼–ï¼ˆPlan9ï¼‰
é‚£åœ¨AOTçš„ç¼–è¯‘å‹è¯­è¨€ä¸­ï¼Œæ˜¯å¦ä¼šæœ‰ä¸ä¸€æ ·çš„å‘¢ï¼Ÿ

```go
package main

func foo() int{
  return 0x123456
}

func main(){
  var b int=1
  for i:=0; i<foo(); i++ {
    b++
  }
  //...
}
```

è¿è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼Œ`-l`ä¸ºå…³é—­inline
```
go tool compile -l -S a.go
```

å¯ä»¥å‘ç°fooä¾æ—§å­˜åœ¨æ¯ä¸ªå¾ªç¯ä¸­ï¼Œç¼–è¯‘å™¨ä»ç„¶æ²¡æœ‰å¯¹å…¶åšä¼˜åŒ–ï¼ˆè¿™é‡Œæ³¨æ„Golangä½¿ç”¨çš„Plan9æ±‡ç¼–æ˜¯Intel operand orderçš„ï¼Œè§ä¸‹å›¾CMPæŒ‡ä»¤ï¼‰
![](./4.png)

### Golang åæ±‡ç¼–ï¼ˆX86 machine codeï¼‰
ç”±äºGolangçš„æ±‡ç¼–è·Ÿæœ€ç»ˆè¿è¡Œåœ¨æœºå™¨ä¸Šçš„æœºå™¨ç è¿˜ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæƒ³è¦æœ€ç»ˆç¡®è®¤ä¸€ä¸‹æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶ä¸­æ˜¯å¦è¿˜æ˜¯æ²¡æœ‰åšä¼˜åŒ–ã€‚

è¿è¡Œç¼–è¯‘ï¼Œæ¥ç€ç”¨objdumpåæ±‡ç¼–
```
go build -gcflags '-l' -o a_l a.go
objdump -d a_l
```

![](./5.png)

ç»“æœä¾æ—§æ²¡æœ‰å¦‚æ„¿

## è§£å†³

è§£å†³æ–¹æ¡ˆéå¸¸ç®€å•ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“fooæ¯æ¬¡è°ƒç”¨çš„è¿”å›å€¼æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯ä»¥å…ˆæå‰è®¡ç®—å®ƒã€‚

```js
var a = 0;
var length = foo();
for (var i = 0; i < length; i++) {
  a++;
}
```

é‚£ä¹ˆä¸ºä»€ä¹ˆå¯¹äºç¨‹åºå‘˜æ¥è¯´è¿™ä¹ˆæ˜æ˜¾çš„é—®é¢˜ï¼Œç¼–è¯‘å™¨ä¼˜åŒ–å´ç†Ÿè§†æ— ç¹å‘¢ï¼Ÿ

æœ‰ä¸€ä¸ªåŸå› ä¸»è¦æ˜¯ï¼Œå¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªéå¸¸éš¾çš„é—®é¢˜ï¼Œéœ€è¦å¤§é‡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œ`foo`å¯èƒ½ä¼šæœ‰å‰¯ä½œç”¨

```js
var global_cnt = 0
function foo(){
  global_cnt++
}
```

**æ­¤æ—¶å¦‚æœç¼–è¯‘å™¨å¸®ä½ åšäº†è¿™ä¸ªä¼˜åŒ–ï¼Œé‚£å°±ä¼šå¯¼è‡´ä¼˜åŒ–å‰å’Œä¼˜åŒ–åçš„è¡¨ç°æ˜¯ä¸ä¸€è‡´çš„ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¼šé€‰æ‹©ä¸å»åšè¿™ä¸ªä¼˜åŒ–ã€‚**

## Why it matterï¼Ÿ
å¯èƒ½æœ‰äº›åŒå­¦ä¼šè¯´ï¼Œè¿™ä¸ªé—®é¢˜ä¸ä¸¥é‡ï¼Œå°±ç®—å®ƒæ¯ä¸€ä¸ªå¾ªç¯éƒ½æ‰§è¡Œä¹Ÿä¸ä¼šæœ‰é—®é¢˜ã€‚

é‚£æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªæ›´åŠ å…·ä½“çš„ä¾‹å­ï¼Œæ•°ä¸€ä¸‹æœ‰å¤šå°‘ä¸ªğŸ’°ï¼Œå¹¶å¯¹æ¯”ä¸¤ç§æ–¹æ³•ã€‚

```js
var Benchmark = require("benchmark");
var suite = new Benchmark.Suite();

function getCharacterLength(str) {
  return [...str].length;
}

var demoWithFuncInLoop = (str) => {
  var a = 0;
  for (var i = 0; i < getCharacterLength(str); i++) {
    a++;
  }
};

var demoWithoutFuncInLoop = (str) => {
  var a = 0;
  var length = getCharacterLength(str);
  for (var i = 0; i < length; i++) {
    a++;
  }
};

var strArr = [1, 2, 3, 4].map((i) => {
  return new Array(10 ** i+1).join("ğŸ’°");
});

strArr.forEach((str, i) => {
  suite.add(`in: string length 1e${i+1}`, function () {
    demoWithFuncInLoop(str);
  });
});

strArr.forEach((str, i) => {
  suite.add(`out: string length 1e${i+1}`, function () {
    demoWithoutFuncInLoop(str);
  });
});

suite
  .on("cycle", function (event) {
    console.log(String(event.target));
  })
  .run({ async: true });
```

ä¸‹é¢æ˜¯æ‰§è¡Œåçš„benchmarkï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ**å¾ªç¯è°ƒç”¨`getCharacterLength`æ˜¯å¾ˆå¯æ€•çš„O(n^2)çš„å¤æ‚åº¦ï¼Œæ¶ˆè€—çš„æ—¶é—´ä¹Ÿæ˜¯æŒ‡æ•°å‹ä¸Šå‡çš„ã€‚å¦‚æœæˆ‘ä»¬ä¸å°å¿ƒå†™äº†è¿™æ ·çš„ä»£ç ï¼Œé‚£åœ¨1e5ä¸ªğŸ’°æ—¶ï¼Œå¤§æ¦‚éœ€è¦200s+æ‰èƒ½å¤Ÿè¿è¡Œå®Œä¸Šè¿°é€»è¾‘ï¼›å¦‚æœæ˜¯1e6ï¼Œåˆ™éœ€è¦6å°æ—¶ï¼ŒåŸºæœ¬ä¸Šè¿™æ®µä»£ç æ˜¯ä¸å¯ç”¨çš„çŠ¶æ€ã€‚è€Œæ­£ç¡®çš„æ–¹å¼ï¼ˆoutï¼‰å¤§æ¦‚æ˜¯ä¸ªO(n)çš„å¤æ‚åº¦ï¼Œæ€§èƒ½æ˜¯(in)çš„10000å€**ã€‚

```
in: string length 1e1 x 493,563 ops/sec Â±0.31% (87 runs sampled)
in: string length 1e2 x 6,317 ops/sec Â±0.50% (96 runs sampled)
in: string length 1e3 x 66.25 ops/sec Â±0.96% (68 runs sampled)
in: string length 1e4 x 0.43 ops/sec Â±0.85% (6 runs sampled)
out: string length 1e1 x 5,359,604 ops/sec Â±0.26% (97 runs sampled)
out: string length 1e2 x 573,066 ops/sec Â±0.13% (95 runs sampled)
out: string length 1e3 x 61,642 ops/sec Â±0.20% (93 runs sampled)
out: string length 1e4 x 4,214 ops/sec Â±0.55% (93 runs sampled)
```

## æ€»ç»“
ç¼–è¯‘å™¨ä¼˜åŒ–ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæœ‰äº›å¯¹ç¨‹åºå‘˜éå¸¸ç®€å•çš„ç‚¹ï¼Œå¯¹ç¼–è¯‘å™¨æ¥è¯´å´å¾ˆéš¾ã€‚å¾€å¾€è¿™äº›ç»†èŠ‚ç‚¹åœ¨å¹³æ—¶å¾ˆå®¹æ˜“è¢«å¿½è§†ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå¾€å¾€åœ¨å°æ•°æ®é‡çš„æ—¶å€™ä¸ä¼šè¢«å‘ç°ï¼Œè€Œå½“å¤æ‚åº¦æ˜¯æŒ‡æ•°å¢é•¿æ—¶ï¼Œåœ¨ç¨å¾®å¤§ä¸€äº›çš„æ•°æ®é‡å°±ä¼šé€ æˆæ€§èƒ½é—®é¢˜ã€‚æ‰€ä»¥æˆ‘ä»¬ç¨‹åºå‘˜éœ€è¦é‡è§†è¿™äº›ç»†èŠ‚ç‚¹ï¼Œä¸ç¼–è¯‘å™¨äº’ç›¸åˆä½œï¼Œæ‰èƒ½ç¼–å†™å‡ºé«˜æ€§èƒ½çš„ä»£ç ã€‚